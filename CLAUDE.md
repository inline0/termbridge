# Termbridge

Local terminal beaming CLI. Exposes your terminal via a public HTTPS URL for mobile access.

## Project Overview

Termbridge is an open-source CLI that runs entirely on the user's machine. It starts a local web server with a browser UI and WebSocket endpoint, backed by tmux PTY streaming or a Daytona sandbox. A Cloudflare tunnel exposes the local server on a public HTTPS URL with QR code for easy mobile access.

**Package name:** `termbridge`
**Version:** 0.3.0
**License:** MIT

---

## Monorepo Structure

```
termbridge/
├── cli/                        # Main publishable package
│   ├── src/
│   │   ├── bin.ts             # Entry point
│   │   ├── cli/               # CLI orchestration
│   │   │   ├── args.ts        # Argument parsing
│   │   │   ├── help.ts        # Help text
│   │   │   ├── run.ts         # CLI dispatcher
│   │   │   ├── start.ts       # Start command
│   │   │   └── ink.tsx        # Ink-based TTY UI
│   │   └── server/            # HTTP/WebSocket server
│   │       ├── server.ts      # Core handlers
│   │       ├── auth.ts        # Token/session management
│   │       ├── rate-limit.ts  # Rate limiting
│   │       ├── static.ts      # Static file serving
│   │       ├── terminal-registry.ts
│   │       └── parse-client-message.ts
│   ├── ui/                    # React UI (Vite)
│   │   └── src/
│   │       ├── main.tsx, app.tsx, router.tsx
│   │       ├── terminal-page.tsx     # Main terminal view with connection indicator
│   │       ├── terminal-client.ts    # xterm.js WebSocket + reconnection logic
│   │       ├── terminal-controls.tsx # Input bar and action buttons
│   │       ├── terminal-switcher.tsx # Session picker bottom sheet
│   │       ├── view-tabs.tsx         # Terminal/Preview tabs (proxy mode)
│   │       ├── bottom-sheet.tsx      # Silk-based bottom sheet component
│   │       └── styles.css            # Global styles + xterm overrides
│   ├── integration/           # E2E tests (tmux + Playwright)
│   ├── dist/                  # Built CLI (tsup)
│   └── package.json
├── packages/
│   ├── shared/                # Protocol types
│   ├── terminal/              # tmux backend (node-pty)
│   ├── tunnel/                # Cloudflare tunnel
│   └── ui/                    # Reusable React components
├── apps/
│   └── docs/                  # Next.js + OneDocs site
├── scripts/
│   └── dev-beam.mjs           # Dev workflow script
├── vitest.config.ts           # Unit test config
├── vitest.cli.config.ts       # E2E test config
├── vitest.setup.ts            # Test mocks
└── biome.json
```

---

## Packages

### @termbridge/shared
Protocol definitions for WebSocket communication.

```ts
// Terminal types
type TerminalListItem = { id, label, status, createdAt, source }
type TerminalListResponse = { terminals: TerminalListItem[] }
type TerminalCreateRequest = { name?: string }

// Message types
type TerminalClientMessage =
  | { type: "input", data: string }
  | { type: "resize", cols: number, rows: number }
  | { type: "control", key: ControlKey }

type TerminalServerMessage =
  | { type: "output", data: string }
  | { type: "status", state: "connected"|"disconnected"|"error" }

// Control keys
type ControlKey = "ctrl_c"|"esc"|"tab"|"up"|"down"|"left"|"right"
```

### @termbridge/terminal
tmux backend via node-pty.

```ts
createSession(name): Promise<void>
write(sessionName, data): Promise<void>
resize(sessionName, cols, rows): void
sendControl(sessionName, key): void
onOutput(sessionName, callback): unsubscribe
closeSession(sessionName): void
```

### @termbridge/tunnel
Cloudflare tunnel integration.

```ts
start(localUrl): Promise<{ publicUrl: string }>
stop(): Promise<void>
```

### @termbridge/ui
Reusable React component library with Tailwind CSS.

---

## CLI Commands

```bash
termbridge                    # Start (default command)
termbridge start              # Explicit start
termbridge help               # Show help
```

### Flags

| Flag | Description | Default |
|------|-------------|---------|
| `--port <port>` | Fixed local port | Random |
| `--proxy <port>` | Proxy a local dev server (enables Terminal/Preview tabs) | - |
| `--dev-proxy-url <url>` | Direct URL for iframe in dev mode (enables HMR) | - |
| `--session <name>` | tmux session name | Autogenerated |
| `--kill-on-exit` | Kill tmux on exit | false |
| `--no-qr` | Disable QR code | false |
| `--tunnel cloudflare` | Tunnel provider | cloudflare |
| `--backend <tmux|daytona>` | Terminal backend | tmux |

---

## HTTP Endpoints

All termbridge routes are under the `/__tb/` prefix to avoid conflicts with proxied apps.

| Endpoint | Description |
|----------|-------------|
| `GET /__tb/s/:token` | Token redemption → cookie → redirect |
| `GET /__tb/api/terminals` | List terminals (auth required) |
| `POST /__tb/api/terminals` | Create terminal (auth required) |
| `GET /__tb/api/csrf` | Get CSRF token for WebSocket connections |
| `GET /__tb/api/config` | Get config (proxyPort, devProxyUrl) |
| `GET /__tb/healthz` | Health check |
| `GET /__tb/app/*` | SPA fallback |
| `WS /__tb/ws/terminal/:terminalId?csrf=<token>` | Terminal WebSocket (requires CSRF token) |
| `GET /` | Redirects to `/__tb/app` (when proxy mode disabled) |
| `* /*` | Proxied to target app (when proxy mode enabled) |

---

## Security

### One-time Token
- 128-bit random, base64url encoded
- SHA-256 hashed server-side
- 90-second TTL, single use

### Session
- 144-bit session ID in HttpOnly cookie
- 30-minute idle timeout, 8-hour max
- CSRF token stored in session for WebSocket protection
- `TERMBRIDGE_INSECURE_COOKIE=1` for local dev

### CSRF Protection
- WebSocket upgrades require CSRF token in query param
- Token fetched via `GET /api/csrf` (requires valid session)
- Prevents cross-site WebSocket hijacking

### Input Limits
- HTTP request body: 64KB max
- WebSocket message: 1MB max
- Terminal input per message: 64KB max

### Rate Limiting
- Per-IP limits on token redemption
- Per-IP limits on WebSocket connects

---

## Daytona sandboxes

Set the backend to Daytona via `TERMBRIDGE_BACKEND=daytona`, then configure repo + access:

```bash
DAYTONA_API_KEY=your_key
DAYTONA_API_URL=https://app.daytona.io/api
TERMBRIDGE_DAYTONA_REPO=https://github.com/inline0/termbridge-test-app.git
TERMBRIDGE_DAYTONA_BRANCH=main
TERMBRIDGE_DAYTONA_PATH=termbridge-test-app
TERMBRIDGE_DAYTONA_NAME=termbridge-sandbox
TERMBRIDGE_DAYTONA_GIT_USERNAME=your_github_username
TERMBRIDGE_DAYTONA_GIT_TOKEN=your_github_token
TERMBRIDGE_DAYTONA_PUBLIC=true
TERMBRIDGE_DAYTONA_PREVIEW_PORT=5173
TERMBRIDGE_DAYTONA_DELETE_ON_EXIT=true
```

For E2E runs, prefer a `termbridge-test-*` name and enable delete-on-exit so sandboxes are cleaned up automatically.

---

## Commands

```bash
# Development
bun run dev              # Build CLI + Vite dev server
bun run dev:beam         # Full dev workflow with tunnel
bun run dev:beam:multi   # Multi-session dev (2 terminals)
bun run dev:beam:proxy   # Dev with proxy mode (set TERMBRIDGE_PROXY_PORT)

# Building
bun run build            # Build CLI + UI

# Testing
bun run test             # All tests
bun run test:mocked      # Unit/integration (100% coverage)
bun run test:cli         # Real CLI + Playwright E2E

# Quality
bun run lint             # Biome lint
bun run typecheck        # TypeScript check
bun run format           # Biome format
```

---

## Environment Variables

| Variable | Description |
|----------|-------------|
| `TERMBRIDGE_SESSIONS=<n>` | Create N tmux sessions on start |
| `TERMBRIDGE_INSECURE_COOKIE=1` | Allow HTTP cookies (dev) |
| `TERMBRIDGE_PROXY_PORT=<port>` | Proxy port for dev:beam:proxy script |
| `TERMBRIDGE_DEV_PORT=<port>` | Override termbridge server port in dev |
| `TERMBRIDGE_DEV_UI=<url>` | Override Vite dev URL |
| `NODE_ENV=test` | Skip auto-main in bin.ts |

---

## Testing

### Unit Tests (Vitest)
- **UI tests:** jsdom, `cli/ui/src/**/*.test.tsx`
- **Node tests:** node env, all other `**/*.test.ts`
- **Coverage:** 100% enforced (lines, functions, branches, statements)

### E2E Tests
- Real CLI + tmux + Playwright
- 60-second timeout
- Config: `vitest.cli.config.ts`

### Test Setup (vitest.setup.ts)
Mocks for:
- `@xterm/xterm` (Terminal class)
- `@xterm/addon-fit` (FitAddon)
- DOM APIs (matchMedia, ResizeObserver, CSS.supports)

---

## Data Flow

```
Browser → Public URL (tunnel) → Local HTTP/WS → tmux session
```

1. Browser connects to Cloudflare tunnel URL
2. `GET /__tb/s/:token` redeems token, sets session cookie
3. Redirect to `/__tb/app`, load React SPA
4. Fetch CSRF token via `GET /__tb/api/csrf`
5. WebSocket to `/__tb/ws/terminal/:terminalId?csrf=<token>`
6. Server validates session, CSRF, and terminal ID
7. Streams tmux PTY output to client
8. Client sends input/resize/control back

### Proxy Mode

When `--proxy <port>` is passed:
- UI shows Terminal/Preview tabs
- All non-`/__tb/` requests are proxied to the target app
- Preview tab shows iframe pointing to `/` (or `devProxyUrl` in dev mode)
- Terminal and controls remain accessible while previewing

---

## Terminal Client

### Connection States
- `connecting` - Initial connection attempt
- `connected` - WebSocket open and ready
- `reconnecting` - Connection lost, attempting reconnect
- `disconnected` - Connection failed after max retries

### Reconnection Logic
- Exponential backoff: 1s base, 30s max delay
- Max 10 reconnect attempts before giving up
- Automatic reconnect on unexpected disconnect
- UI shows connection status indicator (colored dot)

---

## Build

### CLI (tsup)
- Entry: `src/bin.ts`
- Output: `dist/bin.js` (ESM)
- Target: Node 18+

### UI (Vite)
- Entry: `ui/src/main.tsx`
- Output: `ui/dist/` (served by server)
- Stack: React 19, TanStack Router, xterm.js, Tailwind

---

## Dependencies

**CLI Runtime:**
- `ink@^6.6.0` - TTY UI
- `node-pty@^1.1.0` - PTY spawning
- `qrcode-terminal@^0.12.0` - ASCII QR
- `ws@^8.19.0` - WebSocket server

**UI:**
- `react@^19.2.3`
- `@tanstack/react-router@^1.151.6`
- `@xterm/xterm@^6.0.0` + addons
- `tailwindcss@^4.1.18`

**Internal packages:** `@termbridge/shared`, `@termbridge/terminal`, `@termbridge/tunnel`, `@termbridge/ui`

---

## Prerequisites

**Runtime (end users):**
- Node.js 18+
- tmux in PATH
- cloudflared in PATH

**Development:**
- Bun 1.2.22+
- tmux, cloudflared
- Playwright (`bunx playwright install chromium`)
